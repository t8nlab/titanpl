name: TitanPl Development and Production Env Testing

on:
  push:
    branches: [ main ]
    paths-ignore:
      - 'status/**'

permissions:
  contents: write

jobs:
  titanpl:
    runs-on: ubuntu-latest

    steps:
      # ---------------- CHECKOUT ----------------
      - uses: actions/checkout@v4

      # ---------------- SETUP ----------------
      - uses: actions/setup-node@v4
        with:
          node-version: 20

      - uses: dtolnay/rust-toolchain@stable

      - name: Install jq + lsof
        run: sudo apt-get update && sudo apt-get install -y jq lsof curl

      - name: Install Titan CLI
        run: npm install -g @ezetgalaxy/titan@latest

      # ---------------- INIT PROJECT ----------------
      - name: Init TitanPl Project
        run: titan init demo -t js

      # ---------------- HEALTH ACTION ----------------
      - name: Add Health Action
        run: |
          mkdir -p demo/app/actions
          cat <<'EOF' > demo/app/actions/health.js
          export default defineAction((req) => {
            const result = {
              ok: true,
              timestamp: t.time.timestamp(),
              env: {},
              runtime: {},
              tests: {},
              warnings: [],
              failed: []
            };

            // -------- DRIFT TEST --------
            try {
              let ok = false;

              for (let i = 0; i < 3 && !ok; i++) {
                try {
                  const raw = drift(t.fetch("https://dog.ceo/api/breeds/image/random"));
                  if (raw && raw.length > 10) {
                    const data = JSON.parse(raw.body);
                    ok = data.status === "success";
                  }
                } catch {}
              }

              result.tests.drift = ok;
              if (!ok) result.warnings.push("drift-network");
            } catch {
              result.warnings.push("drift-crash");
            }

            // -------- ENV + RUNTIME --------
            try {
              result.env = {
                platform: t.os.platform(),
                cpus: t.os.cpus(),
                memTotal: t.os.totalMemory(),
                memFree: t.os.freeMemory(),
                pid: t.proc.pid(),
                uptime: t.proc.uptime(),
                dev: !!t.fs.exists(".titan")
              };

              try {
                t.fs.writeFile("health.tmp","ok");
                result.tests.fs = t.fs.readFile("health.tmp")==="ok";
                t.fs.remove("health.tmp");
              } catch { result.failed.push("fs"); }

              try { result.tests.crypto = !!t.crypto.hash("sha256","titan"); }
              catch { result.failed.push("crypto"); }

              try { result.tests.buffer = t.buffer.toBase64("hello").length>0; }
              catch { result.failed.push("buffer"); }

              try {
                const token=t.jwt.sign({a:1},"titan-health-secret",{expiresIn:"2m"});
                result.tests.jwt = t.jwt.verify(token,"titan-health-secret").a===1;
              } catch { result.failed.push("jwt"); }

              try {
                const h=t.password.hash("123");
                result.tests.password=t.password.verify("123",h);
              } catch { result.failed.push("password"); }

              try { result.tests.net=t.net.ip().length>0; }
              catch { result.failed.push("net"); }

              try { t.ls.set("h","1"); result.tests.ls=t.ls.get("h")==="1"; }
              catch { result.failed.push("ls"); }

              try { result.tests.response=!!t.response.json({ok:true}); }
              catch { result.failed.push("response"); }

              result.runtime={
                pid:t.proc.pid(),
                uptime:t.proc.uptime(),
                memory:t.proc.memory()
              };

            } catch(err){
              result.ok=false;
              result.warnings.push(String(err));
            }

            if(result.failed.length>0) result.ok=false;
            return result;
          });
          EOF

      # ---------------- APP.JS ----------------
      - name: Update routes
        run: |
          cat <<EOF > demo/app/app.js
          import t from "../titan/titan.js";
          t.get("/").reply("ok");
          t.get("/h").action("health");
          t.start(5100, "TitanPl dev-prod test", 6);
          EOF

      # ---------------- DEV ----------------
      - name: Dev Run
        continue-on-error: true
        run: |
          cd demo
          titan dev &
          echo "Waiting Titan Dev..."
          READY=false

          for i in {1..180}; do
            if curl -s http://127.0.0.1:5100/ > /dev/null; then
              READY=true
              break
            fi
            sleep 2
          done

          if [ "$READY" = true ]; then
            curl -s http://127.0.0.1:5100/h > ../dev.json || echo '{"ok":false}' > ../dev.json
          else
            echo '{"ok":false,"stage":"dev-timeout"}' > ../dev.json
          fi

          PID=$(lsof -t -i:5100 2>/dev/null)
          [ -n "$PID" ] && kill $PID || true

      # ---------------- BUILD ----------------
      - name: Production Build
        continue-on-error: true
        run: cd demo && titan build || true

      # ---------------- DOCKER ----------------
      - name: Docker Build
        continue-on-error: true
        run: cd demo && docker build -t titanpl-test . || true

      - name: Docker Run
        continue-on-error: true
        run: |
          if docker images | grep -q titanpl-test; then
            docker run -d -p 5100:5100 --name titanpl-run titanpl-test

            echo "Waiting Container..."
            READY=false
            for i in {1..90}; do
              if curl -s http://127.0.0.1:5100/ > /dev/null; then
                READY=true
                break
              fi
              sleep 2
            done

            if [ "$READY" = true ]; then
              curl -s http://127.0.0.1:5100/h > prod.json || echo '{"ok":false}' > prod.json
            else
              echo '{"ok":false,"stage":"prod-timeout"}' > prod.json
            fi
          else
            echo '{"ok":false,"stage":"no-image"}' > prod.json
          fi

      - name: Stop Container
        if: always()
        run: docker stop titanpl-run || true

      # ---------------- ENSURE JSON ----------------
      - name: Ensure JSON
        if: always()
        run: |
          [ -f dev.json ] || echo '{"ok":false}' > dev.json
          [ -f prod.json ] || echo '{"ok":false}' > prod.json

      # ---------------- STATUS ----------------
      - name: Prepare Status
        if: always()
        run: |
          DATE=$(date +%Y-%m-%d_%H-%M-%S)
          COMMIT=$(git rev-parse --short HEAD)
          mkdir -p status
          jq -n --arg date "$DATE" --arg commit "$COMMIT" \
          --slurpfile dev dev.json --slurpfile prod prod.json \
          '{date:$date,commit:$commit,dev:$dev[0],production:$prod[0]}' \
          > status/$DATE-$COMMIT.json

      - name: Commit Status
        if: always()
        run: |
          git config user.name "TitanPl CI"
          git config user.email "ci@titan.local"
          git add status/
          git diff --cached --quiet || (git commit -m "Titan CI Log" && git push)

      # ---------------- FINAL FAIL ----------------
      - name: Final Health Check
        if: always()
        run: grep '"ok":false' dev.json prod.json && exit 1 || exit 0
